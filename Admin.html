<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin SD</title>
    <link rel="icon" type="image/x-icon" href="https://lh3.googleusercontent.com/d/16rll5zsRdwTbR3nF_NmPKwY51tg4tnOn">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

    <style>
        :root {
            --sidebar-width: 260px;
            --sidebar-bg: #2c3e50;
            --sidebar-hover: #34495e;
            --accent-color: #27ae60;
            --text-light: #ecf0f1;
            --danger: #e74c3c;
            --primary: #3498db;
            --warning: #f1c40f;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background-color: #f4f6f9; color: #333; overflow-x: hidden; }

        /* --- LOGIN OVERLAY --- */
        #login-overlay {
            position: fixed; inset: 0; background: #2c3e50; z-index: 9999;
            display: flex; justify-content: center; align-items: center;
        }
        .login-card {
            background: white; padding: 2.5rem; border-radius: 12px; width: 100%; max-width: 400px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center;
            animation: slideUp 0.5s ease-out;
        }
        .login-input {
            width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd;
            border-radius: 6px; font-size: 14px; outline: none; transition: 0.3s;
        }
        .login-input:focus { border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.2); }
        .login-btn {
            width: 100%; padding: 12px; background: var(--accent-color); color: white;
            border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: 0.3s;
        }
        .login-btn:hover { background: #219150; }

        /* --- SIDEBAR CUSTOM --- */
        .sidebar {
            position: fixed; top: 0; left: 0; height: 100%; width: var(--sidebar-width);
            background: var(--sidebar-bg); color: var(--text-light);
            transition: all 0.3s ease; z-index: 100;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        
        /* Class Hidden Sidebar */
        .sidebar.hide {
            transform: translateX(-100%);
        }

        .sidebar-header {
            padding: 20px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.1);
        }
        .sidebar-header h2 { font-size: 1.5rem; font-weight: 700; letter-spacing: 1px; }
        .sidebar-header span { font-size: 0.8rem; opacity: 0.7; }

        .nav-links { list-style: none; padding-top: 20px; }
        .nav-links li { position: relative; }
        
        .nav-links li a {
            display: flex; align-items: center; padding: 15px 25px;
            color: #bdc3c7; text-decoration: none; transition: 0.3s;
            border-left: 4px solid transparent;
            cursor: pointer;
        }
        
        .nav-links li a:hover, .nav-links li a.active {
            background: var(--sidebar-hover); color: white; border-left-color: var(--accent-color);
        }
        
        /* Dropdown Submenu Styles */
        .dropdown-btn { justify-content: space-between; }
        .dropdown-icon { transition: transform 0.3s; font-size: 0.8rem !important; margin-right: 0 !important; }
        .dropdown-btn.open .dropdown-icon { transform: rotate(180deg); }
        
        .sub-menu {
            display: none;
            background: rgba(0,0,0,0.2);
            list-style: none;
        }
        .sub-menu.show { display: block; }
        .sub-menu li a {
            padding-left: 55px;
            font-size: 0.9rem;
            color: #bdc3c7;
        }
        .sub-menu li a:hover, .sub-menu li a.active-sub {
            color: white;
            background: rgba(255,255,255,0.05);
            border-left-color: transparent;
        }
        .sub-menu li a.active-sub { color: var(--accent-color); font-weight: 600; }

        .nav-links li a i { margin-right: 15px; width: 25px; text-align: center; font-size: 1.1rem; }
        .nav-links li a:hover i { transform: scale(1.2); transition: transform 0.2s; }

        /* --- MAIN CONTENT --- */
        .main-content {
            margin-left: var(--sidebar-width); padding: 30px;
            transition: margin-left 0.3s ease;
            position: relative;
        }
        
        /* Class Full Main Content */
        .main-content.full {
            margin-left: 0;
        }

        /* Toggle Button */
        .btn-toggle-sidebar {
            background: none; border: none; font-size: 1.4rem; color: #2c3e50; 
            cursor: pointer; margin-bottom: 20px; display: inline-block;
            transition: color 0.2s;
        }
        .btn-toggle-sidebar:hover { color: var(--accent-color); }

        .header-title { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .header-title h1 { font-size: 1.8rem; color: #2c3e50; }
        .school-badge { background: #e8f5e9; color: #2e7d32; padding: 5px 15px; border-radius: 20px; font-size: 0.9rem; font-weight: 600; border: 1px solid #c8e6c9; }

        /* --- CARDS & TABLES --- */
        .card { background: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); overflow: hidden; margin-bottom: 20px; }
        .card-body { padding: 25px; }
        
        .btn { padding: 8px 16px; border-radius: 4px; border: none; cursor: pointer; font-size: 0.9rem; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; text-decoration: none; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--accent-color); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: var(--warning); color: #333; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }

        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px 20px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; font-weight: 600; color: #555; text-transform: uppercase; font-size: 0.85rem; letter-spacing: 0.5px; }
        tr:hover { background: #f1f2f6; }
        
        .status-active { color: var(--accent-color); font-weight: 600; }
        .gender-badge { display: inline-block; width: 25px; height: 25px; line-height: 25px; text-align: center; border-radius: 50%; color: white; font-size: 0.8rem; }
        .gender-l { background-color: #3498db; }
        .gender-p { background-color: #e91e63; }
        
        .score-badge { font-weight: bold; padding: 4px 10px; border-radius: 12px; font-size: 0.85rem; }
        .score-high { background: #d4edda; color: #155724; }
        .score-mid { background: #fff3cd; color: #856404; }
        .score-low { background: #f8d7da; color: #721c24; }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card {
            background: white; padding: 25px; border-radius: 10px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-left: 5px solid var(--accent-color);
            transition: transform 0.2s; position: relative; overflow: hidden;
        }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-card h3 { font-size: 2.2rem; color: #2c3e50; margin-bottom: 5px; font-weight: 700; }
        .stat-card p { color: #7f8c8d; font-size: 0.95rem; margin: 0; font-weight: 500; }
        .stat-icon { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); font-size: 3rem; opacity: 0.1; color: #333; }
        .stat-loading { font-size: 1.5rem; color: #bdc3c7; }

        /* Tutorial Section Custom */
        .tutorial-section {
            background: white; padding: 30px; border-radius: 8px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .tutorial-step {
            display: flex; gap: 20px; margin-bottom: 25px; align-items: flex-start;
        }
        .tutorial-step:last-child { margin-bottom: 0; }
        .step-number {
            width: 40px; height: 40px; background: var(--accent-color); color: white;
            font-weight: bold; border-radius: 50%; display: flex; 
            align-items: center; justify-content: center; flex-shrink: 0;
            font-size: 1.1rem; box-shadow: 0 4px 10px rgba(39, 174, 96, 0.3);
        }
        .step-content h4 {
            margin-bottom: 5px; color: #2c3e50; font-size: 1.1rem;
        }
        .step-content p {
            color: #666; font-size: 0.95rem; line-height: 1.6;
        }

        /* Search Input Style */
        .search-container { position: relative; }
        .search-container input {
            padding-left: 35px;
            width: 250px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 8px 10px 8px 35px;
            outline: none;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .search-container input:focus { border-color: var(--accent-color); width: 280px; }
        .search-container i { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #aaa; }

        /* --- MODAL --- */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5); backdrop-filter: blur(3px);
            align-items: center; justify-content: center;
        }
        .modal-content {
            background-color: #fefefe; border-radius: 8px; width: 100%; max-width: 600px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.2); animation: zoomIn 0.3s; position: relative;
        }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid #eee; background: #f8f9fa; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; max-height: 70vh; overflow-y: auto; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 0.9rem; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; outline: none; }
        .form-control:focus { border-color: var(--accent-color); }
        .modal-footer { padding: 15px 20px; border-top: 1px solid #eee; text-align: right; }
        
        .row-group { display: flex; gap: 15px; }
        .row-group .form-group { flex: 1; }

        /* Alert Modal */
        #alert-modal-content { text-align: center; padding: 30px; }
        .alert-icon { font-size: 3rem; margin-bottom: 15px; display: block; }
        .text-success { color: var(--accent-color); }
        .text-error { color: var(--danger); }
        .text-warning { color: var(--warning); }

        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes zoomIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .hidden { display: none !important; }
        .file-upload-wrapper { border: 2px dashed #ddd; padding: 20px; text-align: center; border-radius: 6px; cursor: pointer; transition: 0.2s; }
        .file-upload-wrapper:hover { border-color: var(--accent-color); background: #f0f8ff; }
    </style>
</head>
<body>

    <!-- === LOGIN GATE === -->
    <div id="login-overlay">
        <div class="login-card">
            <h2 style="margin-bottom: 10px; color: #2c3e50;">Admin Sekolah</h2>
            <p style="margin-bottom: 20px; font-size: 0.9rem; color: #7f8c8d;">Silakan login dengan akun Admin Sekolah</p>
            <form id="form-login" onsubmit="event.preventDefault(); handleLogin();">
                <input type="text" id="login-user" class="login-input" placeholder="Username Admin" required>
                <input type="password" id="login-pass" class="login-input" placeholder="Password" required>
                <button type="submit" id="btn-login" class="login-btn">MASUK <i class="fas fa-arrow-right ms-2"></i></button>
            </form>
        </div>
    </div>

    <!-- === APP CONTAINER (HIDDEN UNTIL LOGIN) === -->
    <div id="app-container" class="hidden">
        
        <!-- SIDEBAR -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>PUSMENDIK</h2>
                <span>Panel Admin Sekolah</span>
            </div>
            <ul class="nav-links">
                <li>
                    <a href="./">
                        <i class="fas fa-home"></i> Home
                    </a>
                </li>
                <li>
                    <a onclick="switchView('info', this)" id="menu-info" class="nav-link-main active">
                        <i class="fas fa-info-circle"></i> Info & Tutorial
                    </a>
                </li>
                
                <!-- Menu Data Siswa -->
                <li>
                    <a onclick="switchView('siswa', this)" class="nav-link-main" id="menu-siswa">
                        <i class="fas fa-user-graduate"></i> Data Siswa
                    </a>
                </li>

                <!-- Menu Matematika (Dropdown) -->
                <li>
                    <a onclick="toggleSubmenu('sub-matematika', this)" class="dropdown-btn nav-link-main">
                        <div style="display:flex; align-items:center;">
                            <i class="fas fa-calculator"></i> Matematika
                        </div>
                        <i class="fas fa-chevron-down dropdown-icon"></i>
                    </a>
                    <ul id="sub-matematika" class="sub-menu">
                        <li><a onclick="loadNilaiFiltered('Matematika', 'TO1', this)">Try Out 1</a></li>
                        <li><a onclick="loadNilaiFiltered('Matematika', 'TO2', this)">Try Out 2</a></li>
                        <li><a onclick="loadNilaiFiltered('Matematika', 'TO3', this)">Try Out 3</a></li>
                        <li><a onclick="loadNilaiFiltered('Matematika', 'TO4', this)">Try Out 4</a></li>
                        <li><a onclick="loadNilaiFiltered('Matematika', 'TO5', this)">Try Out 5</a></li>
                    </ul>
                </li>

                <!-- Menu Bahasa (Dropdown) -->
                <li>
                    <a onclick="toggleSubmenu('sub-bahasa', this)" class="dropdown-btn nav-link-main">
                        <div style="display:flex; align-items:center;">
                            <i class="fas fa-language"></i> Bahasa
                        </div>
                        <i class="fas fa-chevron-down dropdown-icon"></i>
                    </a>
                    <ul id="sub-bahasa" class="sub-menu">
                        <li><a onclick="loadNilaiFiltered('Bahasa Indonesia', 'TO1', this)">Try Out 1</a></li>
                        <li><a onclick="loadNilaiFiltered('Bahasa Indonesia', 'TO2', this)">Try Out 2</a></li>
                        <li><a onclick="loadNilaiFiltered('Bahasa Indonesia', 'TO3', this)">Try Out 3</a></li>
                        <li><a onclick="loadNilaiFiltered('Bahasa Indonesia', 'TO4', this)">Try Out 4</a></li>
                        <li><a onclick="loadNilaiFiltered('Bahasa Indonesia', 'TO5', this)">Try Out 5</a></li>
                    </ul>
                </li>
                
                <!-- NEW FEATURE: GANTI PASSWORD -->
                <li>
                    <a onclick="openModal('modal-ganti-password')" class="nav-link-main">
                        <i class="fas fa-key"></i> Ganti Password
                    </a>
                </li>

                <li style="margin-top: 30px;"><a href="#" onclick="doLogout()"><i class="fas fa-sign-out-alt"></i> Keluar</a></li>
            </ul>
        </nav>

        <!-- MAIN CONTENT -->
        <div class="main-content" id="main-content">
            
            <!-- TOGGLE SIDEBAR BUTTON -->
            <button onclick="toggleSidebar()" class="btn-toggle-sidebar" title="Geser Sidebar">
                <i class="fas fa-bars"></i>
            </button>
            
            <!-- VIEW: INFO & TUTORIAL (DEFAULT) -->
            <div id="view-info">
                <div class="header-title">
                    <div>
                        <h1>Dashboard & Info</h1>
                        <span id="school-info" class="school-badge"><i class="fas fa-school"></i> Memuat Sekolah...</span>
                    </div>
                </div>

                <!-- STATS DASHBOARD -->
                <div class="stats-grid">
                    <!-- Card 1: Total Siswa -->
                    <div class="stat-card">
                        <h3 id="stat-total-siswa"><i class="fas fa-circle-notch fa-spin stat-loading"></i></h3>
                        <p>Total Siswa</p>
                        <i class="fas fa-users stat-icon"></i>
                    </div>

                    <!-- Card 2: Siswa Mengerjakan (Participated) -->
                    <div class="stat-card" style="border-left-color: var(--primary);">
                        <h3 id="stat-mengerjakan"><i class="fas fa-circle-notch fa-spin stat-loading"></i></h3>
                        <p>Siswa Sudah Ujian</p>
                        <i class="fas fa-laptop-code stat-icon"></i>
                    </div>

                    <!-- Card 3: Siswa Dapat Point (Same as participated/Finished in this context) -->
                    <div class="stat-card" style="border-left-color: var(--warning);">
                        <h3 id="stat-nilai"><i class="fas fa-circle-notch fa-spin stat-loading"></i></h3>
                        <p>Siswa Dinilai</p>
                        <i class="fas fa-star stat-icon"></i>
                    </div>

                    <!-- Card 4 & 5: Bank Soal -->
                    <div class="stat-card" style="border-left-color: #9b59b6;">
                        <h3 id="stat-soal-mat"><i class="fas fa-circle-notch fa-spin stat-loading"></i></h3>
                        <p>Bank Soal Matematika</p>
                        <i class="fas fa-calculator stat-icon"></i>
                    </div>

                    <div class="stat-card" style="border-left-color: #e67e22;">
                        <h3 id="stat-soal-ind"><i class="fas fa-circle-notch fa-spin stat-loading"></i></h3>
                        <p>Bank Soal Bahasa</p>
                        <i class="fas fa-language stat-icon"></i>
                    </div>
                </div>

                <!-- TUTORIAL SECTION (UPDATED) -->
                <div class="tutorial-section">
                    <h2 style="margin-bottom:20px; color:#2c3e50; border-bottom:2px solid #eee; padding-bottom:10px;">
                        <i class="fas fa-book text-success"></i> Panduan Penggunaan
                    </h2>
                    
                    <div class="tutorial-step">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <h4>Manajemen Data Siswa</h4>
                            <p>Buka menu <b>Data Siswa</b>. Anda bisa menambahkan siswa satu per satu atau menggunakan fitur <b>Import Excel</b> agar lebih cepat.</p>
                        </div>
                    </div>

                    <div class="tutorial-step">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <h4>Monitoring Hasil Ujian</h4>
                            <p>Gunakan menu <b>Matematika</b> atau <b>Bahasa</b> di sidebar. Klik sub-menu <b>Try Out (TO)</b> yang diinginkan.</p>
                        </div>
                    </div>

                    <div class="tutorial-step">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <h4>Ganti Password</h4>
                            <p>Demi keamanan, Anda dapat mengganti password akun Admin Sekolah melalui menu <b>Ganti Password</b> di sidebar.</p>
                        </div>
                    </div>

                    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; text-align: center; color: #7f8c8d; font-size: 0.9rem;">
                        <p>Aplikasi Admin Sekolah &copy; 2025 PUSMENDIK. Versi 1.1.1</p>
                    </div>
                </div>
            </div>

            <!-- VIEW: DATA SISWA -->
            <div id="view-siswa" class="hidden">
                <div class="header-title">
                    <div>
                        <h1>Data Siswa</h1>
                        <p class="text-gray-500 text-sm">Kelola data siswa sekolah Anda.</p>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="confirmResetSiswa()" class="btn btn-danger"><i class="fas fa-trash-alt"></i> Reset</button>
                        <button onclick="openModal('modal-upload-siswa')" class="btn btn-success"><i class="fas fa-file-excel"></i> Excel</button>
                        <button onclick="openModal('modal-add-siswa')" class="btn btn-primary"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
                
                <div class="card">
                    <table>
                        <thead>
                            <tr>
                                <th>NISN (Username)</th>
                                <th>Nama Lengkap</th>
                                <th>L/P</th>
                                <th>NIK</th>
                                <th>Tgl Lahir</th>
                                <th style="text-align: right;">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="table-siswa-body">
                            <!-- Data injected via JS -->
                        </tbody>
                    </table>
                    <div id="loading-siswa" style="text-align: center; padding: 20px; color: #777;">
                        <i class="fas fa-circle-notch fa-spin"></i> Memuat data siswa...
                    </div>
                </div>
            </div>

            <!-- VIEW: HASIL UJIAN -->
            <div id="view-nilai" class="hidden">
                <div class="header-title">
                    <div>
                        <h1 id="title-nilai">Hasil Ujian</h1>
                        <p id="subtitle-nilai" class="text-gray-500 text-sm">Pilih Kategori Try Out di sidebar untuk melihat nilai.</p>
                    </div>
                    <!-- Action Bar: Search, Reset, Refresh & Download -->
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <div class="search-container">
                            <i class="fas fa-search"></i>
                            <input type="text" id="search-nilai" onkeyup="filterNilaiByName()" placeholder="Cari Nama Siswa...">
                        </div>
                        
                        <!-- NEW: Tombol Reset Nilai -->
                        <button onclick="confirmResetNilai()" class="btn btn-warning" title="Reset Nilai Sekolah (Hanya Mapel & TO ini)">
                            <i class="fas fa-trash-restore"></i> Reset Nilai
                        </button>
                        
                        <button onclick="refreshCurrentNilai()" class="btn btn-primary"><i class="fas fa-sync-alt"></i> Refresh</button>
                        <button onclick="downloadPDF()" class="btn btn-danger"><i class="fas fa-file-pdf"></i></button>
                    </div>
                </div>

                <div class="card">
                    <table>
                        <thead>
                            <tr>
                                <th>NISN</th>
                                <th>Nama Siswa</th>
                                <th>Jenis Kelamin</th>
                                <th>Skor</th>
                                <th>Nilai Akhir</th>
                            </tr>
                        </thead>
                        <tbody id="table-nilai-body">
                            <!-- Data injected via JS -->
                        </tbody>
                    </table>
                    <div id="loading-nilai" class="hidden" style="text-align: center; padding: 20px; color: #777;">
                        <i class="fas fa-circle-notch fa-spin"></i> Menghitung nilai siswa...
                    </div>
                    <div id="empty-nilai" class="hidden" style="text-align: center; padding: 20px; color: #777;">
                        Belum ada data nilai untuk kategori ini.
                    </div>
                    <div id="instruction-nilai" style="text-align: center; padding: 40px; color: #999;">
                        <i class="fas fa-arrow-left fa-2x mb-2"></i><br>
                        Silakan pilih <b>Mapel</b> dan <b>Try Out (TO)</b> pada menu sidebar sebelah kiri.
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- === MODALS === -->

    <!-- MODAL CONFIRM GENERIC (Updated) -->
    <div id="modal-confirm" class="modal" style="z-index: 2001;">
        <div class="modal-content" style="max-width: 350px;">
            <div style="text-align: center; padding: 30px;">
                <i class="fas fa-exclamation-triangle text-warning" style="font-size: 3rem; margin-bottom: 15px; display:block;"></i>
                <h3 style="margin-bottom: 10px;">Konfirmasi</h3>
                <p id="confirm-msg" style="color: #666; margin-bottom: 25px;">Yakin ingin melakukan ini?</p>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button onclick="closeModal('modal-confirm')" class="btn btn-primary" style="min-width: 80px;">Batal</button>
                    <button id="btn-confirm-yes" class="btn btn-danger" style="min-width: 80px;">Ya, Hapus</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODAL GANTI PASSWORD (NEW) -->
    <div id="modal-ganti-password" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3><i class="fas fa-key text-warning"></i> Ganti Password</h3>
                <button onclick="closeModal('modal-ganti-password')" class="btn" style="background:none;"><i class="fas fa-times"></i></button>
            </div>
            <form onsubmit="event.preventDefault(); submitGantiPassword();">
                <div class="modal-body">
                    <div class="form-group">
                        <label>Password Lama</label>
                        <input type="password" id="pass-old" class="form-control" placeholder="Masukkan password saat ini" required>
                    </div>
                    <div class="form-group">
                        <label>Password Baru</label>
                        <input type="password" id="pass-new" class="form-control" placeholder="Password baru" required>
                    </div>
                    <div class="form-group">
                        <label>Konfirmasi Password Baru</label>
                        <input type="password" id="pass-confirm" class="form-control" placeholder="Ulangi password baru" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" onclick="closeModal('modal-ganti-password')" class="btn btn-warning">Batal</button>
                    <button type="submit" class="btn btn-success">Simpan Password</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL ADD/EDIT SISWA -->
    <div id="modal-add-siswa" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-plus text-success"></i> <span id="title-modal-siswa">Tambah Siswa</span></h3>
                <button onclick="closeModal('modal-add-siswa')" class="btn" style="background:none; color:#333;"><i class="fas fa-times"></i></button>
            </div>
            <form onsubmit="event.preventDefault(); saveSiswa();">
                <div class="modal-body">
                    <input type="hidden" id="siswa-id">
                    
                    <div class="form-group">
                        <label>Nama Lengkap</label>
                        <input type="text" id="siswa-nama" class="form-control" placeholder="Nama Lengkap Siswa" required>
                    </div>

                    <div class="row-group">
                        <div class="form-group">
                            <label>NISN (Username)</label>
                            <input type="text" id="siswa-username" class="form-control" placeholder="NISN" required>
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input type="text" id="siswa-password" class="form-control" placeholder="Default: NISN" required>
                        </div>
                    </div>

                    <div class="row-group">
                        <div class="form-group">
                            <label>NIK</label>
                            <input type="text" id="siswa-nik" class="form-control" placeholder="Nomor Induk Kependudukan">
                        </div>
                        <div class="form-group">
                            <label>Jenis Kelamin</label>
                            <select id="siswa-jk" class="form-control" required>
                                <option value="L">Laki-laki</option>
                                <option value="P">Perempuan</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Tanggal Lahir</label>
                        <input type="date" id="siswa-tgl" class="form-control">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" onclick="closeModal('modal-add-siswa')" class="btn btn-warning">Batal</button>
                    <button type="submit" class="btn btn-success">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL UPLOAD EXCEL -->
    <div id="modal-upload-siswa" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Import Siswa dari Excel</h3>
                <button onclick="closeModal('modal-upload-siswa')" class="btn" style="background:none;"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <!-- DOWNLOAD TEMPLATE BUTTON -->
                <div style="text-align: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px;">
                    <button onclick="downloadTemplate()" class="btn btn-primary" style="width: 100%; margin-bottom: 5px;">
                        <i class="fas fa-download"></i> Download Format Template Excel
                    </button>
                    <p style="font-size: 0.8rem; color: #888;">
                        Gunakan file ini untuk mengisi data siswa, lalu upload kembali di bawah.
                    </p>
                </div>

                <p style="font-size: 0.9rem; color: #666; margin-bottom: 10px;">
                    <b>Upload File Excel:</b>
                </p>
                <div class="file-upload-wrapper" onclick="document.getElementById('file-siswa').click()">
                    <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: #aaa;"></i>
                    <p>Klik untuk pilih file Excel (.xlsx)</p>
                    <input type="file" id="file-siswa" accept=".xlsx, .xls" style="display: none;" onchange="processExcelSiswa(this)">
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL ALERT CUSTOM -->
    <div id="modal-alert" class="modal" style="z-index: 2000;">
        <div class="modal-content" style="max-width: 350px;">
            <div id="alert-modal-content">
                <i id="alert-icon" class="fas fa-check-circle alert-icon text-success"></i>
                <h3 id="alert-title">Berhasil!</h3>
                <p id="alert-msg" style="color: #666; margin-top: 5px;">Data telah disimpan.</p>
                <button onclick="closeModal('modal-alert')" class="btn btn-success" style="margin-top: 20px; width: 100%;">OK</button>
            </div>
        </div>
    </div>

    <!-- === LOGIC === -->
    <script>
        // --- 1. CONFIGURATION ---
        const SB_URL = 'https://splkwqvcjhkaquticmsl.supabase.co';
        const SB_KEY = 'sb_publishable_3X8ykgq95Tw1__HhPWc7uA_j1Q-u7xL'; // Key Public
        
        const db = window.supabase.createClient(SB_URL, SB_KEY);

        let currentAdmin = null;
        let currentSchoolName = '';
        
        // GLOBAL Action state untuk Modal Konfirmasi
        let pendingConfirmAction = null; 
        
        // State Filter Nilai
        let activeMapel = null;
        let activeKategori = null;

        // --- 2. AUTHENTICATION & LOGIN ---
        
        // Cek Session saat Load
        document.addEventListener('DOMContentLoaded', checkSession);

        async function checkSession() {
            const session = localStorage.getItem('admin_session');
            if (session) {
                try {
                    const data = JSON.parse(session);
                    // Langsung set user dari cache untuk kecepatan (tanpa request ulang)
                    currentAdmin = data;
                    currentSchoolName = data.sekolah ? data.sekolah.nama_sekolah : 'Sekolah Tidak Dikenal';

                    document.getElementById('login-overlay').style.display = 'none';
                    document.getElementById('app-container').classList.remove('hidden');
                    document.getElementById('school-info').innerHTML = `<i class="fas fa-school"></i> ${currentSchoolName} (${data.npsn})`;
                    
                    // Default View: Info & Tutorial
                    switchView('info', document.getElementById('menu-info'));
                } catch (e) {
                    console.error("Session invalid", e);
                    localStorage.removeItem('admin_session');
                }
            }
        }

        async function handleLogin() {
            const u = document.getElementById('login-user').value;
            const p = document.getElementById('login-pass').value;
            const btn = document.getElementById('btn-login');
            
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Checking...';
            
            const { data, error } = await db
                .from('akun_admin')
                .select('*, sekolah(nama_sekolah)')
                .eq('username', u)
                .eq('password', p)
                .single();

            if (data) {
                // Simpan session
                localStorage.setItem('admin_session', JSON.stringify(data));

                currentAdmin = data;
                currentSchoolName = data.sekolah ? data.sekolah.nama_sekolah : 'Sekolah Tidak Dikenal';
                
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('app-container').classList.remove('hidden');
                document.getElementById('school-info').innerHTML = `<i class="fas fa-school"></i> ${currentSchoolName} (${data.npsn})`;
                
                // Redirect ke Info & Tutorial setelah login berhasil
                switchView('info', document.getElementById('menu-info'));
            } else {
                showAlert('Login Gagal', 'Username atau Password salah.', false);
                btn.innerHTML = 'MASUK <i class="fas fa-arrow-right ms-2"></i>';
            }
        }

        function doLogout() {
            localStorage.removeItem('admin_session');
            location.reload();
        }

        // --- 3. MENU & NAVIGATION SYSTEM ---
        
        function toggleSubmenu(id, btn) {
            // Close other submenus
            document.querySelectorAll('.sub-menu').forEach(el => {
                if(el.id !== id) el.classList.remove('show');
            });
            document.querySelectorAll('.dropdown-btn').forEach(el => {
                if(el !== btn) el.classList.remove('open');
            });

            // Toggle current
            const submenu = document.getElementById(id);
            submenu.classList.toggle('show');
            btn.classList.toggle('open');
        }

        function switchView(viewName, element) {
            // Reset active state for main links
            document.querySelectorAll('.nav-link-main').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.sub-menu li a').forEach(el => el.classList.remove('active-sub'));
            
            if(element) element.classList.add('active');

            // Hide all views
            document.getElementById('view-info').classList.add('hidden'); // Hide Info
            document.getElementById('view-siswa').classList.add('hidden');
            document.getElementById('view-nilai').classList.add('hidden');

            // Show selected
            const target = document.getElementById('view-' + viewName);
            if(target) target.classList.remove('hidden');

            if(viewName === 'siswa') loadSiswa();
            if(viewName === 'info') loadInfoStats(); // Load stats on view info
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const content = document.getElementById('main-content');
            
            sidebar.classList.toggle('hide');
            content.classList.toggle('full');
        }
        
        // --- NEW FEATURE: GANTI PASSWORD ---
        async function submitGantiPassword() {
            if(!currentAdmin) return;
            const oldP = document.getElementById('pass-old').value;
            const newP = document.getElementById('pass-new').value;
            const confP = document.getElementById('pass-confirm').value;

            if(oldP !== currentAdmin.password) {
                showAlert('Gagal', 'Password Lama salah!', false);
                return;
            }
            if(newP !== confP) {
                showAlert('Gagal', 'Konfirmasi Password Baru tidak cocok.', false);
                return;
            }
            if(newP.length < 3) {
                 showAlert('Gagal', 'Password terlalu pendek.', false);
                 return;
            }

            showLoading('Mengupdate Password...');

            // Update ke DB
            const { error } = await db.from('akun_admin').update({ password: newP }).eq('id', currentAdmin.id);

            if(!error) {
                // Update local session data agar tidak perlu relogin
                currentAdmin.password = newP;
                localStorage.setItem('admin_session', JSON.stringify(currentAdmin));
                
                closeModal('modal-ganti-password');
                // Reset form
                document.getElementById('pass-old').value = '';
                document.getElementById('pass-new').value = '';
                document.getElementById('pass-confirm').value = '';
                
                showAlert('Berhasil', 'Password berhasil diubah.', true);
            } else {
                showAlert('Error', 'Gagal update: ' + error.message, false);
            }
        }


        // --- STATS LOGIC ---
        async function loadInfoStats() {
            if(!currentAdmin) return;
            
            // UI Loading state
            const loadingIcon = '<i class="fas fa-circle-notch fa-spin stat-loading"></i>';
            document.getElementById('stat-total-siswa').innerHTML = loadingIcon;
            document.getElementById('stat-mengerjakan').innerHTML = loadingIcon;
            document.getElementById('stat-nilai').innerHTML = loadingIcon;
            document.getElementById('stat-soal-mat').innerHTML = loadingIcon;
            document.getElementById('stat-soal-ind').innerHTML = loadingIcon;
            
            try {
                // 1. Total Siswa (dari NPSN sekolah ini)
                const { count: countSiswa, data: dataSiswa } = await db
                    .from('akun_siswa')
                    .select('id', { count: 'exact' })
                    .eq('npsn', currentAdmin.npsn);
                
                document.getElementById('stat-total-siswa').innerText = countSiswa || 0;

                // 2. Siswa Mengerjakan (Unique IDs di tabel jawaban_siswa yg match dgn siswa sekolah ini)
                let countMengerjakan = 0;
                if(dataSiswa && dataSiswa.length > 0) {
                    const ids = dataSiswa.map(s => s.id);
                    // Supabase 'in' filter limit sekitar 65k parameter, should be safe for school scope
                    const { data: dataJawab } = await db
                        .from('jawaban_siswa')
                        .select('siswa_id')
                        .in('siswa_id', ids);
                        
                    if(dataJawab) {
                        // Hitung unik
                        const unique = new Set(dataJawab.map(j => j.siswa_id));
                        countMengerjakan = unique.size;
                    }
                }
                document.getElementById('stat-mengerjakan').innerText = countMengerjakan;
                // Asumsi: Siswa yang mengerjakan sudah pasti dapat dinilai sistem
                document.getElementById('stat-nilai').innerText = countMengerjakan;

                // 3. Jumlah Soal (Global) - Matematika
                const { count: countMat } = await db
                    .from('soal')
                    .select('id', { count: 'exact', head: true })
                    .eq('mapel', 'Matematika');
                document.getElementById('stat-soal-mat').innerText = countMat || 0;

                // 4. Jumlah Soal (Global) - Bahasa Indonesia
                const { count: countInd } = await db
                    .from('soal')
                    .select('id', { count: 'exact', head: true })
                    .eq('mapel', 'Bahasa Indonesia');
                document.getElementById('stat-soal-ind').innerText = countInd || 0;

            } catch (err) {
                console.error("Gagal memuat statistik", err);
                document.getElementById('stat-total-siswa').innerText = '-';
            }
        }

        function loadNilaiFiltered(mapel, kategori, element) {
            // UI Update
            document.querySelectorAll('.nav-link-main').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.sub-menu li a').forEach(el => el.classList.remove('active-sub'));
            
            // Highlight Submenu Item
            if(element) element.classList.add('active-sub');
            
            // Highlight Parent Dropdown (Optional visual cue)
            const parentBtn = element.closest('li').querySelector('.dropdown-btn');
            if(parentBtn) parentBtn.classList.add('active');

            // Switch View
            document.getElementById('view-info').classList.add('hidden');
            document.getElementById('view-siswa').classList.add('hidden');
            document.getElementById('view-nilai').classList.remove('hidden');

            // Set State & Load
            activeMapel = mapel;
            activeKategori = kategori;
            
            document.getElementById('title-nilai').innerText = `Hasil Ujian: ${kategori}`;
            document.getElementById('subtitle-nilai').innerText = `Mata Pelajaran: ${mapel}`;
            
            // Reset Search Input
            document.getElementById('search-nilai').value = '';
            
            loadNilai();
        }

        function refreshCurrentNilai() {
            if(activeMapel && activeKategori) {
                loadNilai();
            } else {
                showAlert("Info", "Silakan pilih kategori TO di sidebar terlebih dahulu.", true);
            }
        }

        // --- 4. CRUD: MANAJEMEN SISWA ---
        async function loadSiswa() {
            if (!currentAdmin) return;

            const tbody = document.getElementById('table-siswa-body');
            document.getElementById('loading-siswa').classList.remove('hidden');
            tbody.innerHTML = '';

            const { data, error } = await db
                .from('akun_siswa')
                .select('*')
                .eq('npsn', currentAdmin.npsn) 
                .order('nama_lengkap', { ascending: true });

            document.getElementById('loading-siswa').classList.add('hidden');

            if (data && data.length > 0) {
                data.forEach(item => {
                    const jkClass = item.jenis_kelamin === 'L' ? 'gender-l' : 'gender-p';
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td style="font-weight:bold; color:#2c3e50;">${item.username}</td>
                        <td>${item.nama_lengkap}</td>
                        <td><span class="gender-badge ${jkClass}">${item.jenis_kelamin}</span></td>
                        <td>${item.nik || '-'}</td>
                        <td>${item.tanggal_lahir || '-'}</td>
                        <td style="text-align: right;">
                            <div class="actions" style="justify-content: flex-end; display:flex; gap:5px;">
                                <button onclick="editSiswa('${item.id}', '${item.username}', '${item.password}', '${item.nama_lengkap}', '${item.nik}', '${item.jenis_kelamin}', '${item.tanggal_lahir}')" class="btn btn-warning" style="padding: 5px 10px;"><i class="fas fa-edit"></i></button>
                                <button onclick="deleteSiswa('${item.id}')" class="btn btn-danger" style="padding: 5px 10px;"><i class="fas fa-trash"></i></button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Belum ada data siswa.</td></tr>';
            }
        }

        function openModal(id) {
            if(id === 'modal-add-siswa') {
                document.getElementById('title-modal-siswa').innerText = 'Tambah Siswa';
                document.getElementById('siswa-id').value = '';
                document.querySelector('#modal-add-siswa form').reset();
                document.getElementById('siswa-jk').value = 'L'; // Default
            }
            if(id === 'modal-ganti-password') {
                // Reset form fields
                document.getElementById('pass-old').value = '';
                document.getElementById('pass-new').value = '';
                document.getElementById('pass-confirm').value = '';
            }
            document.getElementById(id).style.display = 'flex';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        function editSiswa(id, username, password, nama, nik, jk, tgl) {
            document.getElementById('title-modal-siswa').innerText = 'Edit Siswa';
            document.getElementById('siswa-id').value = id;
            document.getElementById('siswa-username').value = username;
            document.getElementById('siswa-password').value = password;
            document.getElementById('siswa-nama').value = nama;
            document.getElementById('siswa-nik').value = nik === 'null' ? '' : nik;
            document.getElementById('siswa-jk').value = jk;
            document.getElementById('siswa-tgl').value = tgl === 'null' ? '' : tgl;
            openModal('modal-add-siswa');
        }

        async function saveSiswa() {
            if (!currentAdmin) return;

            const id = document.getElementById('siswa-id').value;
            const nama = document.getElementById('siswa-nama').value;
            const username = document.getElementById('siswa-username').value;
            const password = document.getElementById('siswa-password').value;
            const nik = document.getElementById('siswa-nik').value;
            const jk = document.getElementById('siswa-jk').value;
            const tgl = document.getElementById('siswa-tgl').value;

            if(!username || !password || !nama) {
                showAlert('Gagal', 'NISN, Password, dan Nama wajib diisi.', false);
                return;
            }

            closeModal('modal-add-siswa');
            showLoading('Menyimpan Data Siswa...');

            const payload = {
                username: username,
                password: password,
                nama_lengkap: nama,
                nik: nik || null,
                jenis_kelamin: jk,
                tanggal_lahir: tgl || null,
                npsn: currentAdmin.npsn 
            };

            let error;
            if (id) {
                const res = await db.from('akun_siswa').update(payload).eq('id', id);
                error = res.error;
            } else {
                const res = await db.from('akun_siswa').insert(payload);
                error = res.error;
            }

            if (!error) {
                showAlert('Berhasil', 'Data Siswa tersimpan.', true);
                loadSiswa();
            } else {
                showAlert('Gagal', 'Error: ' + error.message, false);
            }
        }

        // --- CORE: GENERIC CONFIRMATION HANDLER ---
        
        // Setup Event Listener untuk tombol YES di modal confirm
        document.getElementById('btn-confirm-yes').addEventListener('click', function() {
            if (pendingConfirmAction) {
                closeModal('modal-confirm');
                pendingConfirmAction(); // Execute stored function
                pendingConfirmAction = null; // Reset
            }
        });

        function openConfirmModal(msg, actionFn) {
            document.getElementById('confirm-msg').innerText = msg;
            pendingConfirmAction = actionFn;
            openModal('modal-confirm');
        }


        // --- DELETE FEATURE 1: HAPUS SISWA & RIWAYAT JAWABAN ---
        function deleteSiswa(id) {
            openConfirmModal("Hapus siswa ini beserta riwayat jawabannya? Data tidak bisa dikembalikan.", () => executeDeleteSiswa(id));
        }

        async function executeDeleteSiswa(targetId) {
            showLoading('Menghapus Data...');
            
            // Step 1: Hapus jawaban dulu (Referential Integrity)
            // Meskipun tidak ada cascade otomatis, kita lakukan manual agar bersih
            const { error: err1 } = await db.from('jawaban_siswa').delete().eq('siswa_id', targetId);
            
            if(err1) {
                showAlert('Gagal', 'Gagal menghapus riwayat jawaban: ' + err1.message, false);
                return;
            }

            // Step 2: Hapus Akun Siswa
            const { error: err2 } = await db.from('akun_siswa').delete().eq('id', targetId);
            
            if (!err2) {
                showAlert('Terhapus', 'Data siswa dan riwayat ujian berhasil dihapus.', true);
                loadSiswa();
            } else {
                showAlert('Gagal', 'Gagal menghapus akun: ' + err2.message, false);
            }
        }

        // --- NEW FEATURE: RESET SEMUA SISWA ---
        function confirmResetSiswa() {
            openConfirmModal("PERINGATAN EKSTRIM: Anda akan MENGHAPUS SELURUH DATA SISWA sekolah ini secara permanen beserta riwayat ujiannya. Data tidak bisa dikembalikan. Yakin?", () => executeResetSiswa());
        }

        async function executeResetSiswa() {
            if(!currentAdmin) return;
            showLoading('Menghapus SELURUH Siswa...');

            try {
                // 1. Get IDs Siswa Sekolah Ini
                const { data: students, error: errGet } = await db
                    .from('akun_siswa')
                    .select('id')
                    .eq('npsn', currentAdmin.npsn);
                
                if(errGet) throw errGet;
                if(!students || students.length === 0) {
                    showAlert('Info', 'Tidak ada data siswa untuk dihapus.', true);
                    return;
                }

                const ids = students.map(s => s.id);

                // 2. Delete Answers (Hapus Jawaban Siswa Sekolah Ini)
                // Menggunakan .in() untuk menghapus jawaban berdasarkan list ID siswa
                const { error: errAns } = await db
                    .from('jawaban_siswa')
                    .delete()
                    .in('siswa_id', ids);

                if(errAns) throw new Error("Gagal menghapus riwayat jawaban: " + errAns.message);

                // 3. Delete Students (Hapus Akun Siswa Sekolah Ini)
                const { error: errSiswa } = await db
                    .from('akun_siswa')
                    .delete()
                    .eq('npsn', currentAdmin.npsn);
                    
                if(errSiswa) throw new Error("Gagal menghapus data siswa: " + errSiswa.message);

                showAlert('BERHASIL', 'Seluruh data siswa telah dihapus.', true);
                loadSiswa();
                loadInfoStats(); // Update stats dashboard

            } catch (err) {
                showAlert('Error', err.message, false);
            }
        }

        // --- DELETE FEATURE 2: RESET NILAI SEKOLAH (PER MAPEL & TO) ---
        function confirmResetNilai() {
            if (!activeMapel || !activeKategori) {
                showAlert('Peringatan', 'Silakan pilih Mapel dan Try Out di sidebar terlebih dahulu.', false);
                return;
            }
            
            const msg = `PERINGATAN: Anda akan menghapus SEMUA nilai ujian siswa SEKOLAH ANDA untuk kategori: \n\n${activeMapel} - ${activeKategori}\n\nAkun siswa TIDAK akan terhapus. Lanjutkan?`;
            openConfirmModal(msg, () => executeResetNilai());
        }

        async function executeResetNilai() {
            if (!currentAdmin || !activeMapel || !activeKategori) return;

            showLoading(`Mereset nilai ${activeKategori}...`);

            try {
                // 1. Ambil List ID Siswa Sekolah Ini
                const { data: students, error: errS } = await db
                    .from('akun_siswa')
                    .select('id')
                    .eq('npsn', currentAdmin.npsn);
                
                if(errS) throw new Error("Gagal mengambil data siswa.");
                if(!students || students.length === 0) throw new Error("Tidak ada data siswa ditemukan.");
                
                const studentIds = students.map(s => s.id);

                // 2. Ambil List ID Soal (Mapel & Kategori Terkait)
                const { data: questions, error: errQ } = await db
                    .from('soal')
                    .select('id')
                    .eq('kategori', activeKategori)
                    .eq('mapel', activeMapel);

                if(errQ) throw new Error("Gagal mengambil data soal.");
                if(!questions || questions.length === 0) throw new Error("Tidak ada soal ditemukan untuk kategori ini.");
                
                const questionIds = questions.map(q => q.id);

                // 3. Eksekusi Hapus (Intersection)
                // Hapus jawaban dimana siswa_id IN (sekolah kita) AND soal_id IN (mapel/TO ini)
                const { error: errDel } = await db
                    .from('jawaban_siswa')
                    .delete()
                    .in('siswa_id', studentIds)
                    .in('soal_id', questionIds);

                if(errDel) throw errDel;

                showAlert('Berhasil', `Nilai ${activeMapel} - ${activeKategori} untuk sekolah Anda berhasil di-reset.`, true);
                loadNilai(); // Refresh tabel

            } catch (err) {
                console.error(err);
                showAlert('Gagal Reset', err.message || "Terjadi kesalahan.", false);
            }
        }


        // --- 5. LOGIC HASIL UJIAN & SCORING ---
        
        // Fungsi Filter Nama (Client Side)
        function filterNilaiByName() {
            const input = document.getElementById('search-nilai');
            const filter = input.value.toUpperCase();
            const table = document.getElementById('table-nilai-body');
            const tr = table.getElementsByTagName('tr');

            for (let i = 0; i < tr.length; i++) {
                const td = tr[i].getElementsByTagName('td')[1]; // Index 1 adalah Nama Siswa
                if (td) {
                    const txtValue = td.textContent || td.innerText;
                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                        tr[i].style.display = "";
                    } else {
                        tr[i].style.display = "none";
                    }
                }       
            }
        }

        async function loadNilai() {
            if (!currentAdmin) return;
            // Jika belum ada filter aktif, jangan load apapun (tunggu user klik sidebar)
            if (!activeMapel || !activeKategori) {
                document.getElementById('instruction-nilai').classList.remove('hidden');
                document.getElementById('loading-nilai').classList.add('hidden');
                document.getElementById('empty-nilai').classList.add('hidden');
                document.getElementById('table-nilai-body').innerHTML = '';
                return;
            }

            const tbody = document.getElementById('table-nilai-body');
            const loading = document.getElementById('loading-nilai');
            const empty = document.getElementById('empty-nilai');
            const instruct = document.getElementById('instruction-nilai');
            
            tbody.innerHTML = '';
            instruct.classList.add('hidden');
            loading.classList.remove('hidden');
            empty.classList.add('hidden');

            try {
                // 1. Ambil Siswa Sekolah Ini (REVISI: Ambil username/NISN dan JK juga)
                const { data: listSiswa, error: errSiswa } = await db
                    .from('akun_siswa')
                    .select('id, nama_lengkap, username, jenis_kelamin')
                    .eq('npsn', currentAdmin.npsn);
                
                if (errSiswa) throw errSiswa;
                if (!listSiswa || listSiswa.length === 0) {
                    loading.classList.add('hidden');
                    empty.classList.remove('hidden');
                    empty.innerText = "Belum ada data siswa di sekolah ini.";
                    return;
                }

                const siswaIds = listSiswa.map(s => s.id);

                // 2. Ambil Jawaban (Filter by Siswa)
                const { data: listJawaban, error: errJawab } = await db
                    .from('jawaban_siswa')
                    .select('siswa_id, soal_id, jawaban_dipilih')
                    .in('siswa_id', siswaIds);

                if (errJawab) throw errJawab;
                if (!listJawaban || listJawaban.length === 0) {
                    loading.classList.add('hidden');
                    empty.classList.remove('hidden');
                    empty.innerText = `Belum ada siswa yang mengerjakan ${activeKategori} - ${activeMapel}.`;
                    return;
                }

                // 3. Ambil Soal (Filter by Kategori & Mapel & ID Jawaban)
                const soalIds = [...new Set(listJawaban.map(j => j.soal_id))];
                const { data: listSoal, error: errSoal } = await db
                    .from('soal')
                    .select('id, kategori, mapel, kunci_jawaban, tipe_soal')
                    .in('id', soalIds)
                    .eq('kategori', activeKategori)
                    .eq('mapel', activeMapel);

                if (errSoal) throw errSoal;
                
                if(!listSoal || listSoal.length === 0) {
                    loading.classList.add('hidden');
                    empty.classList.remove('hidden');
                    empty.innerText = `Tidak ditemukan soal untuk ${activeKategori} - ${activeMapel} yang sudah dikerjakan.`;
                    return;
                }

                // Map Soal Valid
                const soalMap = {};
                listSoal.forEach(s => { soalMap[s.id] = s; });

                // Map Siswa Full Data (Object)
                const siswaMap = {};
                listSiswa.forEach(s => { siswaMap[s.id] = s; });

                // Scoring Calculation
                const resultData = {};

                listJawaban.forEach(j => {
                    const soal = soalMap[j.soal_id];
                    if (!soal) return; // Skip jika soal tidak cocok filter kategori/mapel

                    const siswaId = j.siswa_id;
                    if (!resultData[siswaId]) resultData[siswaId] = { correct: 0, total: 0 };

                    let isCorrect = false;
                    try {
                        const jawabanUser = JSON.parse(j.jawaban_dipilih);
                        let kunciDB = soal.kunci_jawaban;

                        if (soal.tipe_soal === 'pilihan_ganda') {
                            isCorrect = (jawabanUser === kunciDB);
                        } else if (soal.tipe_soal === 'pilihan_ganda_kompleks') {
                            const parsedKunci = (typeof kunciDB === 'string' && (kunciDB.startsWith('[') || kunciDB.startsWith('{'))) 
                                ? JSON.parse(kunciDB) : kunciDB;
                            if (Array.isArray(parsedKunci) && Array.isArray(jawabanUser)) {
                                isCorrect = (JSON.stringify(parsedKunci.sort()) === JSON.stringify(jawabanUser.sort()));
                            }
                        } else if (soal.tipe_soal === 'benar_salah') {
                             const parsedKunci = typeof kunciDB === 'string' ? JSON.parse(kunciDB) : kunciDB;
                             isCorrect = (JSON.stringify(parsedKunci) === JSON.stringify(jawabanUser));
                        } else {
                             isCorrect = (JSON.stringify(jawabanUser) === JSON.stringify(kunciDB));
                        }
                    } catch (e) { console.error(e); }

                    resultData[siswaId].total += 1;
                    if (isCorrect) resultData[siswaId].correct += 1;
                });

                // Render Table (REVISI KOLOM)
                let hasData = false;
                for (const sId in resultData) {
                    hasData = true;
                    const siswaObj = siswaMap[sId];
                    if(!siswaObj) continue;

                    const stats = resultData[sId];
                    const nilai = (stats.correct / stats.total) * 100;

                    let badgeClass = 'score-low';
                    if(nilai >= 80) badgeClass = 'score-high';
                    else if(nilai >= 60) badgeClass = 'score-mid';
                    
                    const jkClass = siswaObj.jenis_kelamin === 'L' ? 'gender-l' : 'gender-p';

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="font-bold text-gray-700">${siswaObj.username}</td>
                        <td>${siswaObj.nama_lengkap}</td>
                        <td><span class="gender-badge ${jkClass}">${siswaObj.jenis_kelamin}</span></td>
                        <td>${stats.correct} / ${stats.total}</td>
                        <td><span class="score-badge ${badgeClass}">${nilai.toFixed(1)}</span></td>
                    `;
                    tbody.appendChild(tr);
                }

                loading.classList.add('hidden');
                if(!hasData) {
                    empty.classList.remove('hidden');
                    empty.innerText = "Data tidak ditemukan.";
                }

            } catch (err) {
                loading.classList.add('hidden');
                showAlert('Error', err.message, false);
            }
        }

        // --- PDF DOWNLOAD FUNCTION ---
        async function downloadPDF() {
            if (!activeMapel || !activeKategori || !currentSchoolName) {
                showAlert('Error', 'Data belum dimuat sepenuhnya.', false);
                return;
            }

            // Pastikan jsPDF sudah terload
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Header Laporan
            doc.setFontSize(16);
            doc.text(`Laporan Hasil Ujian - ${currentSchoolName}`, 14, 20);
            
            doc.setFontSize(11);
            doc.text(`Kategori : ${activeKategori}`, 14, 28);
            doc.text(`Mapel    : ${activeMapel}`, 14, 34);
            doc.text(`Tanggal  : ${new Date().toLocaleDateString('id-ID')}`, 14, 40);

            // Ambil Data Tabel (Filtered/Visible Rows)
            const tableElement = document.getElementById('table-nilai-body');
            const rows = [];
            
            const trs = tableElement.querySelectorAll('tr');
            if (trs.length === 0) {
                showAlert('Info', 'Tidak ada data untuk diunduh.', false);
                return;
            }

            trs.forEach(tr => {
                // Hanya ambil baris yang visible (jika ada filter pencarian)
                if (tr.style.display !== 'none') {
                    const tds = tr.querySelectorAll('td');
                    // Format Baris: [NISN, Nama, L/P, Skor, Nilai]
                    // Kita perlu bersihkan text dari HTML tags jika ada
                    const rowData = [
                        tds[0].innerText, 
                        tds[1].innerText, 
                        tds[2].innerText, 
                        tds[3].innerText, 
                        tds[4].innerText 
                    ];
                    rows.push(rowData);
                }
            });

            // Generate AutoTable
            doc.autoTable({
                startY: 48,
                head: [['NISN', 'Nama Siswa', 'L/P', 'Skor', 'Nilai Akhir']],
                body: rows,
                theme: 'grid',
                styles: { fontSize: 9, cellPadding: 2 },
                headStyles: { fillColor: [44, 62, 80], textColor: 255 }, // Dark Blue header
                alternateRowStyles: { fillColor: [245, 245, 245] }
            });

            // Save PDF
            const filename = `Hasil_${activeKategori}_${activeMapel}_${currentSchoolName.replace(/\s+/g, '_')}.pdf`;
            doc.save(filename);
        }

        // --- 6. EXCEL UPLOAD LOGIC ---
        
        // Fungsi baru untuk download template
        function downloadTemplate() {
            // Data Header + 1 Contoh Baris
            const headers = [
                { 
                    nisn: "1234567890", 
                    nama_lengkap: "Contoh Siswa", 
                    nik: "3201234567890001", 
                    jenis_kelamin: "L", 
                    tanggal_lahir: "2010-01-01" 
                }
            ];
            
            // Create Worksheet
            const ws = XLSX.utils.json_to_sheet(headers);
            
            // Create Workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Template Siswa");
            
            // Download
            XLSX.writeFile(wb, "Template_Import_Siswa.xlsx");
        }

        function processExcelSiswa(input) {
            if (!currentAdmin) return;
            const file = input.files[0];
            if(!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                
                closeModal('modal-upload-siswa');
                showLoading(`Memproses ${jsonData.length} data siswa...`);

                let successCount = 0;
                let failCount = 0;
                for (let row of jsonData) {
                    const nisn = row.nisn ? row.nisn.toString() : null;
                    const nama = row.nama_lengkap || row.nama;
                    if(nisn && nama) {
                        const payload = {
                            username: nisn,
                            password: row.password ? row.password.toString() : nisn,
                            nama_lengkap: nama,
                            nik: row.nik ? row.nik.toString() : null,
                            jenis_kelamin: (row.jenis_kelamin === 'P' || row.jenis_kelamin === 'Perempuan') ? 'P' : 'L',
                            tanggal_lahir: row.tanggal_lahir || null,
                            npsn: currentAdmin.npsn
                        };
                        const { error } = await db.from('akun_siswa').insert(payload);
                        if(!error) successCount++;
                        else failCount++;
                    } else { failCount++; }
                }
                showAlert('Selesai', `${successCount} Berhasil, ${failCount} Gagal/Dilewati.`, true);
                loadSiswa();
                input.value = '';
            };
            reader.readAsArrayBuffer(file);
        }

        // --- UTILS ---
        function showAlert(title, msg, isSuccess) {
            document.getElementById('alert-title').innerText = title;
            document.getElementById('alert-msg').innerText = msg;
            
            const icon = document.getElementById('alert-icon');
            if(isSuccess) {
                icon.className = 'fas fa-check-circle alert-icon text-success';
            } else {
                icon.className = 'fas fa-times-circle alert-icon text-error';
            }
            openModal('modal-alert');
        }

        function showLoading(text) {
            document.getElementById('alert-title').innerText = "Mohon Tunggu";
            document.getElementById('alert-msg').innerText = text;
            document.getElementById('alert-icon').className = 'fas fa-circle-notch fa-spin alert-icon';
            document.getElementById('alert-icon').style.color = '#27ae60';
            openModal('modal-alert');
        }
    </script>
</body>
</html>